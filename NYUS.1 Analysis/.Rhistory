library(rstudioapi)
library(progressr)
library(ggplot2)
library(ggbeeswarm)
library(data.table)
library(purrr)
library(dplyr)
library(tidyr)
library(chillR)
library(lubridate)
library(multcomp)
library(emmeans)
library(multcompView)
library(patchwork)
handlers("txtprogressbar")
# set working directory to source file location
setwd(dirname(getActiveDocumentContext()$path))
# load functions
source("VitisPhenology_functions.r")
# temperature data
wdat <- read.csv("VitisPhenology_data_weather.csv", stringsAsFactors = T)
# location data (with latitudes for hourly and chill calculations)
ldat <- read.csv("VitisPhenology_data_locations.csv", stringsAsFactors = T)
# budbreak data
bbdat <- read.csv("VitisPhenology_data_budbreak.csv", stringsAsFactors = T)
```{r Visualize temperature data}
wdat <- wdat |>
mutate(Date = as.Date(paste(Year, Month, Day, sep="-"), format = "%Y-%m-%d")) |>
left_join(ldat |> dplyr::select(Location, Location2, Country, Latitude),
by = c("Location", "Location2", "Country"))
wdat %>%
group_by(Location, Year) %>%
dplyr::summarise(
mean_Tmax = mean(Tmax, na.rm = TRUE),
mean_Tmin = mean(Tmin, na.rm = TRUE)) |>
ungroup() |>
ggplot() +
geom_smooth(aes(Year, mean_Tmax),alpha=0.7, method = "lm", se = FALSE, color = "red") +
geom_line(aes(Year, mean_Tmax), linewidth=1, color="darkred") +
geom_smooth(aes(Year, mean_Tmin), alpha=0.7, method = "lm", se = FALSE, color = "blue") +
geom_line(aes(Year, mean_Tmin), linewidth=1, color="darkblue") +
labs(x="", y="Annual mean Tmax (red) and Tmin (blue)") +
facet_wrap(~ Location, ncol = 4) +
theme_bw()
wdat %>%
pivot_longer(cols = c(Tmax, Tmin),
names_to = "PlotVar",
values_to = "Temperature") |>
group_by(Location) %>%
mutate(Loc_order = mean(Temperature, na.rm = TRUE),
PlotVar = factor(PlotVar, levels = c("Tmin", "Tmax"))) |>
ungroup() |>
mutate(Location = forcats::fct_reorder(Location, Loc_order)) |>
ggplot(aes(x = Temperature, y = Location, fill = Location)) +
ggridges::geom_density_ridges(scale = 1,
quantile_lines = TRUE,
quantiles = 2) +
facet_wrap(~ PlotVar, ncol = 2) +
theme_bw() +
theme(legend.position = "none")
```{r [1] daily -> hourly | [2] calculate chill | [3] reduce to daily again}
# Chill calculation for all location x year combinations
wdat_chill <- VitisPhenology_compute_chill(wdat, keep_hourly = F)
wdat_chill <- wdat_chill |>
rename(MinC = Tmin,
MaxC = Tmax)
wdat_chill_keep <- wdat_chill
```{r Set up parameter table}
parms <- tribble(
~Cultivar,                 ~tliml, ~tlimh, ~tlimb, ~tlime, ~m,  ~n,  ~b,    ~c,  ~kdeacc_parm, ~a,  ~slp, ~int,
"Concord",                 0,      12,     8,      66,     31,  6,  -2.1,  24,  1.9,          3.5, 3,    5,
"Concord_10",              0,      10,     11,     66,     28,  6,  -2.3,  24,  1.9,          3.5, 3,    4,
"Concord_90",              0,      12,     8,      66,     33,  6,  -2.2,  24,  1.9,          4.0, 2,    4,
"Cabernet_Sauvignon",      0,      8,      7,      66,     23,  6,  -2.2,  22,  1.8,          5.0, 6,    3,
"Cabernet_Sauvignon_10",   0,      6,      6,      66,     22,  6,  -1.7,  14,  1.7,          4.0, 7,    3,
"Cabernet_Sauvignon_90",   0,      10,     6,      66,     25,  6,  -1.9,  24,  1.7,          5.0, 4,    3,
"Riesling",                0,      12,     7,      66,     26,  6,  -1.9,  24,  2.2,          5.0, 3,    4,
"Riesling_10",             0,      10,     6,      66,     24,  6,  -2.0,  14,  2.2,          5.0, 3,    5,
"Riesling_90",             0,      14,     10,     66,     29,  6,  -1.9,  24,  2.0,          5.0, 2,    5
)
```{r Run predictions}
# Cold hardiness is predicted for each cultivar at the 50th, 10th and 90th percentiles
prediction_levels <- parms$Cultivar
preds <- NULL
{start <- Sys.time()
for (i in prediction_levels) {
print(paste("Calculating predictions for",i,":"))
preds <- VitisPhenology_run_predictions(output=preds,
input=wdat_chill,
parameters=parms,
groups=i)
}
end <- Sys.time()
}
end-start
preds_keep <- preds
```{r changes to "preds" to represent damage}
preds2 <- preds |>
mutate(
damlevel = case_when(
Cultivar %in% c("Concord_90", "Riesling_90", "Cabernet_Sauvignon_90") ~ 90,
Cultivar %in% c("Concord", "Riesling", "Cabernet_Sauvignon") ~ 50,
TRUE ~ 10),
Cultivar = case_when(
Cultivar %in% c("Concord_10", "Concord_90") ~ "Concord",
Cultivar %in% c("Riesling_10", "Riesling_90") ~ "Riesling",
Cultivar %in% c("Cabernet_Sauvignon_10", "Cabernet_Sauvignon_90") ~ "Cabernet_Sauvignon",
TRUE ~ Cultivar))
preds2 <- preds2 |>
dplyr::select(Date, Location, Dataset, MinC, MaxC, JDay, Portions, CH, Cultivar, damlevel)
preds3 <- preds2 |>
mutate(damlevel = paste0("CH", damlevel)) |>
pivot_wider(names_from = damlevel,
values_from = CH) |>
mutate(LocDatCult = as.factor(paste(Location, Dataset, Cultivar)),
damage = 0,
CH10r = pmin(CH10, -0.82),
CH50r = pmin(CH50, -1.2),
CH90r = pmin(CH90, -1.6))
# Convert to data.table
setDT(preds3)
preds4 <- preds3[, damage := {
# Local copies of columns
CH10vect <- CH10r
CH50vect <- CH50r
CH90vect <- CH90r
MinCvect <- MinC
# Initialize damage vector
dmg <- rep(NA_real_, .N)
# Rule 1: CH10r > MinC & MinC < 0
idx1 <- which(!is.na(CH10vect) & !is.na(CH50vect) & !is.na(MinCvect) & CH10vect > MinCvect & MinCvect < 0)
dmg[idx1] <- ((50 - 10) / (CH50vect[idx1] - CH10vect[idx1])) * (MinCvect[idx1] - CH10vect[idx1]) + 10
# Rule 2: CH50r > MinC & MinC < 0
idx2 <- which(!is.na(CH50vect) & !is.na(CH90vect) & !is.na(MinCvect) & CH50vect > MinCvect & MinCvect < 0)
dmg[idx2] <- ((90 - 50) / (CH90vect[idx2] - CH50vect[idx2])) * (MinCvect[idx2] - CH50vect[idx2]) + 50
# Rule 3: CH90r > MinC & MinC < 0
idx3 <- which(!is.na(CH90vect) & !is.na(MinCvect) & CH90vect > MinCvect & MinCvect < 0)
dmg[idx3] <- 90
# Monotonic non-decreasing within LocDatCult
damage <- cummax(replace(dmg, is.na(dmg), 0))
}, by = LocDatCult]
preds4 <- preds4 |>
mutate(
# New10: base case
New10 = CH10 + ((CH50 - CH10) / 40) * (((100 - damage) * 0.1 + damage) - 10),
New10 = if_else(damage > 50,
CH10 + ((CH90 - CH10) / 80) * (((100 - damage) * 0.1 + damage) - 10),
New10),
# New50 and New90
New50 = CH50 + ((CH90 - CH50) / 40) * (((100 - damage) * 0.5 + damage) - 50),
New90 = CH90 + ((CH90 - CH50) / 40) * (((100 - damage) * 0.9 + damage) - 90),
# Threshold-adjusted versions
New10r = pmin(New10, -0.82),
New50r = pmin(New50, -1.2),
New90r = pmin(New90, -1.6),
# Intermediate CH values for interpolation
CH20r = CH10r + ((CH50r - CH10r) / 40) * 10,
CH30r = CH10r + ((CH50r - CH10r) / 40) * 20,
CH40r = CH10r + ((CH50r - CH10r) / 40) * 30,
CH60r = CH50r + ((CH90r - CH50r) / 40) * 10,
CH70r = CH50r + ((CH90r - CH50r) / 40) * 20,
CH80r = CH50r + ((CH90r - CH50r) / 40) * 30)
# Modify budbreak data
bbdat2 <- bbdat |>
filter(!(Location == "Vassal" & Dataset == "1974-1975")) # 1974-1975 season budbreak observations in Vassal removed as there is an unreasonable difference of 23 days between Riesling and Cab.-Sauvignon budbreak
# Prepare budbreak data for predictions
bbdatpred <- bbdat2 |>
dplyr::select(Cultivar, Location, BBCH.scale, Observer, Dataset)
preds5 <- full_join(preds4, bbdatpred, by = c("Cultivar", "Location", "Dataset")) |>
mutate(BBCH.scale = replace_na(BBCH.scale, 7),
Observer   = replace_na(Observer, "No_record"))
preds6 <- preds5 |>
mutate(
threshold1 = case_when(
Observer == "Bordenave"  ~ 0,
Cultivar == "Concord"    ~ 5,
BBCH.scale == 5          ~ 5,
TRUE                     ~ 10),
threshold2 = case_when(
Cultivar == "Concord"    ~ 5,
TRUE                     ~ 10))
preds6$ThreshDiff=preds6$New50-preds6$threshold1
BBpreds <- preds6 %>%
group_by(LocDatCult) %>%
dplyr::summarise(
Location   = unique(Location),
Dataset    = unique(Dataset),
Cultivar   = as.factor(unique(Cultivar)),
# Original thresholds
BB10     = as.numeric(JDay[which.min(abs(CH10 - threshold1))]),
BB50     = as.numeric(JDay[which.min(abs(CH50 - threshold1))]),
BB90     = as.numeric(JDay[which.min(abs(CH90 - threshold1))]),
# Corrected thresholds
BB10Cor  = as.numeric(JDay[which.min(abs(New10 - threshold1))]),
BB50Cor  = as.numeric(JDay[which.min(abs(New50 - threshold1))]),
BB90Cor  = as.numeric(JDay[which.min(abs(New90 - threshold1))]),
ThreshDiff = as.numeric(ThreshDiff[which.min(abs(New50 - threshold1))]),
# Final thresholds
BB10Fin  = as.numeric(JDay[which.min(abs(New10 - threshold2))]),
BB50Fin  = as.numeric(JDay[which.min(abs(New50 - threshold2))]),
BB90Fin  = as.numeric(JDay[which.min(abs(New90 - threshold2))]),
# Damage
damage.max   = max(damage, na.rm = TRUE),
damage.bb    = damage[which.min(abs(CH50 - threshold1))],
.groups = "drop")
bbdat3 <- bbdat2 %>%
left_join(BBpreds, by = c("Cultivar", "Location", "Dataset")) %>%
mutate(damage.bin = if_else(damage.bb > 0, 1, 0))
bbdat2b <- bbdat3
# 7.319433
sqrt((sum((bbdat2b$bb.doy-(bbdat2b$BB50))^2))/length(bbdat2b$bb.doy)) #RMSE damaged
